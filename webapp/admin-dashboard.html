<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CleanVision Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="admin-dashboard.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
  <header>
    <h1>CleanVision Dashboard</h1>
  </header>

  <main class="dashboard-container">
    <div class="filter-container">
      <label for="task-filter">View Tasks:</label>
      <select id="task-filter" onchange="filterTasks()">
        <option value="detections" selected>All Detections</option>
      </select>
    </div>

    <div id="pending-tasks" class="task-grid"></div>

    <div id="details-container" class="details-modal">
      <div class="details-content">
        <span class="close-btn" onclick="closeDetails()">&times;</span>
        <img id="task-image" src="" alt="Garbage" />
        <p id="task-location"></p>
        <p id="task-time"></p>
        <div id="map" class="map"></div>
        <div class="assign-section">
          <select id="staff-select">
            <option disabled selected>Select Staff</option>
            <option value="staff1">Ravi Kumar</option>
            <option value="staff2">Anjali Singh</option>
            <option value="staff3">Mohit Verma</option>
          </select>
          <button class="assign-btn">Assign</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    const taskDetails = {};
    let mapInstance;

    async function loadDetections() {
      try {
        const res = await fetch("http://127.0.0.1:8000/api/detections");
        const detections = await res.json();
        const container = document.getElementById("pending-tasks");
        container.innerHTML = "";

        detections.forEach(detection => {
          const taskId = "task_" + detection.detection_id;
          taskDetails[taskId] = {
            id: detection.detection_id,
            location: detection.address,
            time: new Date(detection.timestamp).toLocaleString(),
            lat: detection.latitude,
            lng: detection.longitude,
            img: "https://via.placeholder.com/300x200?text=" + detection.type // Placeholder image
          };

          const card = document.createElement("div");
          card.className = "task-card";
          card.onclick = () => showDetails(taskId);
          card.innerHTML = `
            <p><strong>Location:</strong> ${detection.address}</p>
            <p><strong>Time:</strong> ${new Date(detection.timestamp).toLocaleString()}</p>
            <p><strong>Type:</strong> ${detection.type}</p>
            <p><strong>Camera:</strong> ${detection.camera_id}</p>
          `;
          container.appendChild(card);
        });
      } catch (err) {
        console.error("Failed to load detections", err);
      }
    }

    function showDetails(taskId) {
      const task = taskDetails[taskId];
      document.getElementById("task-image").src = task.img;
      document.getElementById("task-location").textContent = "Location: " + task.location;
      document.getElementById("task-time").textContent = "Time: " + task.time;
      document.getElementById("details-container").style.display = "flex";

      setTimeout(() => {
        const map = L.map("map").setView([task.lat, task.lng], 15);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        L.marker([task.lat, task.lng]).addTo(map);
        mapInstance = map;
      }, 200);
    }

    function closeDetails() {
      document.getElementById("details-container").style.display = "none";
      if (mapInstance) {
        mapInstance.remove();
        mapInstance = null;
      }
    }

    function filterTasks() {
      const selected = document.getElementById("task-filter").value;
      if (selected === "detections") {
        loadDetections();
      }
    }

    window.onload = () => {
      filterTasks();
    };
  </script>
</body>
</html>
